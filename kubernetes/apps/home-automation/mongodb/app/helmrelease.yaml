# ---
# apiVersion: helm.toolkit.fluxcd.io/v2
# kind: HelmRelease
# metadata:
#   name: mongodb
#   namespace: home-automation
# spec:
#   interval: 30m
#   chart:
#     spec:
#       chart: mongodb
#       sourceRef:
#         kind: HelmRepository
#         name: bitnami
#         namespace: flux-system
#   install:
#     remediation:
#       retries: 5
#   upgrade:
#     cleanupOnFail: true
#     remediation:
#       retries: 5
#   uninstall:
#     keepHistory: false
#   values:
#     global:
#       defaultStorageClass: "local-path-provisioner"
#     auth:
#       enabled: true
#       existingSecretPasswordKey: mongodb
#     metrics:
#       enabled: true
#       serviceMonitor:
#         enabled: true
#     persistence:
#       enabled: true
#       storageClass: local-path-provisioner
#     architecture: replicaset
#     backup:
#       enabled: true
#       cronjob:
#         schedule: "@daily"
#         storage:
#           subPath: mongodb-backup
#           existingClaim: unraid-un-nvme-pvc
#     service:
#       type: ClusterIP
#     #   annotations:
#     #     - io.cilium/lb-ipam-ips: "10.0.0.20"
#     #     - io.cilium/lb-ipam-sharing-key: "home-automation-shared"
#     #   externalTrafficPolicy: Cluster
#     #clusterIP: "10.0.0.20"
#     #   type: LoadBalancer
#     externalAccess:
#       enabled: true
#       service:
#         type: LoadBalancer
#         loadBalancerIPs:
#           - '10.0.0.28'
#           - '10.0.0.29'
#         # annotationsList:
#         #   - io.cilium/lb-ipam-ips: "10.0.0.20"
#         #   - io.cilium/lb-ipam-sharing-key: "home-automation-shared"
#     # externalAccess:
#     #   enabled: true
#     #   service:
#     #     type: LoadBalancer
#     #     loadBalancerIPs:
#     #       - '10.0.0.20'
#     #       - '10.0.0.29'
#     #     annotationsList:
#     #       - io.cilium/lb-ipam-ips: "10.0.0.20"


---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: mongodb
  namespace: home-automation
spec:
  interval: 30m
  chart:
    spec:
      chart: mongodb
      sourceRef:
        kind: HelmRepository
        name: bitnami
        namespace: flux-system
  install:
    remediation:
      retries: 5
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 5
  uninstall:
    keepHistory: false
  values:
    global:
      defaultStorageClass: "local-path-provisioner"
    auth:
      enabled: true
      existingSecretPasswordKey: mongodb
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
    persistence:
      enabled: true
      storageClass: local-path-provisioner
    architecture: replicaset
    backup:
      enabled: true
      cronjob:
        command:
          # - tail
          # - -f
          # - /dev/null
          # - /bin/sh
          # - -c
          - /bin/sh
          - -c
          - |
            echo "Env vars:"
            echo "USER: $MONGODB_ROOT_USER"
            echo "PASS FILE: $MONGODB_ROOT_PASSWORD_FILE"
            echo "HOST: $MONGODB_SERVICE_NAME"
            echo "PORT: $MONGODB_PORT_NUMBER"
            echo "DUMP DIR: $MONGODUMP_DIR"
            echo "EXTRA FLAGS: $MONGODB_CLIENT_EXTRA_FLAGS"

            export MONGODB_ROOT_PASSWORD="$(< $MONGODB_ROOT_PASSWORD_FILE)"
            echo $MONGODB_ROOT_PASSWORD

            mongodump --username=${MONGODB_ROOT_USER} --password=${MONGODB_ROOT_PASSWORD} --authenticationDatabase=admin --host=${MONGODB_SERVICE_NAME} --port=${MONGODB_PORT_NUMBER} ${MONGODB_CLIENT_EXTRA_FLAGS} --oplog --gzip --archive=${MONGODUMP_DIR}/mongodump-$(date '+%Y-%m-%d-%H-%M')
        schedule: "@daily"
        storage:
          subPath: mongodb-backup
          existingClaim: unraid-un-nvme-pvc
    externalAccess:
      enabled: false
      service:
        type: LoadBalancer
        loadBalancerIPs:
          - '10.0.0.27'
          - '10.0.0.28'
        annotationsList:
           - io.cilium/lb-ipam-ips: "10.0.0.27"
           - io.cilium/lb-ipam-ips: "10.0.0.28"
          #  - io.cilium/lb-ipam-sharing-key: "home-automation-shared"
          #  - io.cilium/lb-ipam-sharing-key: "home-automation-shared"

